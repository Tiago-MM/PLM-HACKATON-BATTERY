<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Assistant Battery Passport</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* Header */
        header { background: white; padding: 15px 20px; border-bottom: 1px solid #E5E7EB; display: flex; align-items: center; justify-content: space-between; }
        h1 { font-size: 1.2rem; margin: 0; color: #111827; display: flex; align-items: center; gap: 10px; }
        .back-link { text-decoration: none; color: #6B7280; font-size: 0.9rem; font-weight: 500; }

        /* Chat Container */
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        
        /* Messages */
        .message { max-width: 80%; padding: 12px 16px; border-radius: 12px; line-height: 1.5; font-size: 0.95rem; }
        
        .bot-message { align-self: flex-start; background: white; border: 1px solid #E5E7EB; color: #374151; border-bottom-left-radius: 2px; }
        .user-message { align-self: flex-end; background: #2563EB; color: white; border-bottom-right-radius: 2px; }

        /* Input Area */
        .input-area { background: white; padding: 20px; border-top: 1px solid #E5E7EB; display: flex; gap: 10px; }
        
        input[type="text"] {
            flex: 1; padding: 12px 15px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 1rem; outline: none; transition: border-color 0.2s; font-family: inherit;
        }
        input[type="text"]:focus { border-color: #2563EB; }
        
        button {
            background-color: #2563EB; color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background 0.2s;
        }
        button:hover { background-color: #1D4ED8; }

        /* Animation des points (...) */
        .typing { font-style: italic; color: #9CA3AF; font-size: 0.8rem; margin-left: 10px; display: none; }
    </style>
</head>
<body>

    <header>
        <h1>
            <span style="font-size: 24px;">ü§ñ</span> 
            Assistant IA
        </h1>
        <a href="/" class="back-link">Fermer</a>
    </header>

    <div class="chat-container" id="chatBox">
        <div class="message bot-message">
            Bonjour ! Je suis l'assistant du Battery Passport. 
            <br>Je peux vous aider. Que cherchez-vous ?
        </div>
    </div>

    <div style="padding: 0 20px;">
        <span class="typing" id="typingIndicator">L'assistant √©crit...</span>
    </div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="Posez une question sur les batteries..." autocomplete="off">
        <button onclick="sendMessage()">Envoyer</button>
    </div>

    <script>
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const typingIndicator = document.getElementById('typingIndicator');

        // Envoi avec Entr√©e
        userInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") { sendMessage(); }
        });

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. Afficher le message de l'utilisateur
            addMessage(text, 'user');
            userInput.value = '';

            // 2. Afficher "L'assistant √©crit..."
            typingIndicator.style.display = 'block';
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                // 3. ENVOYER LA REQU√äTE AU BACKEND FLASK
                const response = await fetch("/api/chat", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ message: text })
                });

                const data = await response.json();

                // 4. Cacher l'indicateur et afficher la r√©ponse de l'IA
                typingIndicator.style.display = 'none';
                
                // Formater un peu le texte (transformer les sauts de ligne en <br>)
                let formattedResponse = data.response.replace(/\n/g, "<br>");
                
                // Si la r√©ponse contient des √©toiles ** pour le gras (Markdown), on peut faire un replace simple
                formattedResponse = formattedResponse.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                addMessage(formattedResponse, 'bot');

            } catch (error) {
                console.error("Erreur:", error);
                typingIndicator.style.display = 'none';
                addMessage("Erreur de connexion avec le serveur.", 'bot');
            }
        }

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.classList.add('message');
            div.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
            div.innerHTML = text; 
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>

</body>
</html>